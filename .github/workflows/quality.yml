# SPDX-License-Identifier: PMPL-1.0-or-later
name: Code Quality

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions: read-all

jobs:
  quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Checkout proven repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          repository: hyperpolymath/proven
          path: proven

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Documentation consistency checks
        run: ./scripts/qa/check-docs.sh

      - name: Proven cross-repo smoke checks
        run: |
          test -f proven/bindings/rescript/src/ProvenSafePath.res
          test -f proven/bindings/rescript/src/ProvenSafeJson.res
          test -f proven/bindings/rescript/src/ProvenSafeNetwork.res
          test -f proven/Trustfile.a2ml
          grep -q '^env-info:' proven/justfile

      - name: Formatting check
        run: cargo fmt --all -- --check

      - name: Clippy check
        run: cargo clippy --workspace --lib --bins --examples -- -D warnings

      - name: Unit/library tests
        run: cargo test --workspace --lib

      - name: Conformance tests
        run: cargo test -p eclexia --test conformance_tests

      - name: Integration tests
        run: cargo test --workspace --tests

      - name: Point-to-point interop check
        run: cargo run --bin eclexia -- interop check

      - name: End-to-end smoke execution
        run: |
          cargo run --bin eclexia -- run examples/hello.ecl
          cargo run --bin eclexia -- run examples/comprehensive_opportunity.ecl

      - name: Benchmark smoke execution
        run: |
          cargo run --bin eclexia -- bench examples/bench_example.ecl
          cargo run --bin eclexia -- bench examples/bench_energy.ecl

      - name: Optional panic-attack scan
        run: |
          if command -v panic-attack >/dev/null 2>&1; then
            ./scripts/qa/run-panic-attack.sh /tmp/eclexia-panic-attack-ci.json
          else
            echo "::warning::panic-attack not found on runner; install it to enable CI panic-attack scans"
          fi
