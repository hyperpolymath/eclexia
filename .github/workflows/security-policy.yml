# SPDX-License-Identifier: PMPL-1.0-or-later
name: Security Policy

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions: read-all

jobs:
  check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Validate security/trust artifacts
        run: |
          test -f .well-known/security.txt
          test -f .well-known/trust.txt
          test -f .machine_readable/contractiles/trust/Trustfile.a2ml
          test -f .machine_readable/contractiles/lust/Intentfile

      - name: Enforce secure crypto and URL policy in source
        run: |
          set -euo pipefail

          WEAK_CRYPTO=$(grep -rE 'md5\(|sha1\(' --include='*.rs' --include='*.zig' --include='*.idr' --include='*.sh' . 2>/dev/null | grep -v 'checksum\|cache\|test\|spec' || true)
          if [ -n "$WEAK_CRYPTO" ]; then
            echo "Weak crypto usage detected (MD5/SHA1):"
            echo "$WEAK_CRYPTO"
            exit 1
          fi

          HTTP_URLS=$(grep -rE 'http://[^l][^o][^c]' --include='*.rs' --include='*.zig' --include='*.idr' --include='*.sh' --include='*.yml' --include='*.yaml' . 2>/dev/null | grep -v 'localhost\|127.0.0.1\|example\|test\|spec' || true)
          if [ -n "$HTTP_URLS" ]; then
            echo "Non-local HTTP URLs detected in source/config:"
            echo "$HTTP_URLS"
            exit 1
          fi

      - name: Enforce FFI/ABI purity boundaries
        run: |
          set -euo pipefail

          if find ffi -type f ! -name '*.zig' | grep -q .; then
            echo "Non-Zig file detected under ffi/"
            find ffi -type f ! -name '*.zig'
            exit 1
          fi

          if find src/abi -type f ! -name '*.idr' | grep -q .; then
            echo "Non-Idris2 file detected under src/abi/"
            find src/abi -type f ! -name '*.idr'
            exit 1
          fi

      - name: Optional panic-attack scan
        run: |
          if command -v panic-attack >/dev/null 2>&1; then
            ./scripts/qa/run-panic-attack.sh /tmp/eclexia-panic-attack-security.json
          else
            echo "::warning::panic-attack not found on runner; install it to enable security scan enforcement"
          fi

      - name: Security policy check complete
        run: echo "Security policy checks passed"
